# IntegoReport

**IntegoReport** is a Python-based project designed to pull data from various service APIs (initially Freshservice) and potentially link with CRM data (like Mailchimp) to generate insightful reports for demonstrating value to clients. The primary output is HTML reports, managed via a simple Flask web interface.

**Current Status: In Development**

This project is actively being developed. Core features around Freshservice data pulling, Mailchimp contact linking, and HTML report generation via Flask are functional.

## Project Goal

To create a system that can:
1.  Fetch relevant client service data (e.g., helpdesk tickets from Freshservice).
2.  Attempt to link Freshservice clients to contacts in Mailchimp to find primary email addresses.
3.  Process this data to derive key performance indicators and value metrics (e.g., tickets solved, types of issues, resolution times, SLA adherence).
4.  Generate comprehensive and easy-to-understand HTML reports for clients.
5.  Provide a simple Flask-based web interface for internal management:
    * Updating the client list from Freshservice and linking with Mailchimp.
    * Selecting a client to generate a report.
    * Viewing the generated report.
    * Sending the report via Mailchimp to the linked client contact (and an internal copy).
6.  (Future) Integrate with other services (e.g., MS365 usage, Sentinel One alerts) and automate report delivery.

## Core Files and Their Purpose

* **`main.py`**: The main Flask web application. It provides the user interface to:
    * Trigger updates of the client list (which runs `utils/client_updater.py`).
    * Select a client and initiate report generation (runs `data_pullers/freshservice.py` then `build_report.py`).
    * Display a dispatch page with options to view the generated report or send it via Mailchimp.
* **`utils/client_updater.py`**: Script to fetch all clients (companies/departments) from Freshservice.
    * Fetches detailed information for each Freshservice client, including primary contact names.
    * Fetches all contacts from a specified Mailchimp audience.
    * Attempts to link Freshservice clients to Mailchimp contacts by matching contact names or, as a fallback, by matching company email domains.
    * Outputs the consolidated list (with linked emails and link status) to `companies_list.json`.
    * Logs Freshservice contacts that have a prime user/head name but couldn't be found in Mailchimp.
* **`data_pullers/freshservice.py`**: Fetches detailed data for a *specific* client from Freshservice for a defined period (previous full month).
    * This includes tickets, conversations, time entries, satisfaction ratings, and detailed client attributes.
    * Saves this data to a JSON file in the `raw_data/` directory (e.g., `freshservice_{CLIENT_ID}.json`).
* **`build_report.py`**: Generates the final HTML report.
    * Loads data from the most recent JSON file in `raw_data/`.
    * Calculates various statistics (total tickets, resolution times, SLA adherence based on specific definitions, tickets by type/priority/category).
    * Generates HTML table-based bar charts for email-friendly visualization of data distributions.
    * Renders the `output_report.html` file using a Jinja2 template.
* **`token.txt`**: Stores the Freshservice API key (must be in `.gitignore`).
* **`mail_token.txt`**: Stores the Mailchimp API key (must be in `.gitignore`).
* **`companies_list.json`**: Stores the list of clients from Freshservice, including their ID, name, linked Mailchimp email, Mailchimp link status, and the Freshservice contact name that was targeted for linking.
* **`raw_data/` (directory)**: Stores the detailed JSON output from `data_pullers/freshservice.py` for each report run.
* **`templates/` (directory)**:
    * `email_report_template.html`: The Jinja2 template used by `build_report.py` to generate the client-facing HTML report.
    * Other templates used by `main.py` (Flask app): `index.html`, `generating.html`, `dispatch_report.html`.
* **`output_report.html`**: The final HTML report generated by `build_report.py`.

## Current Features

* **Flask Web Interface (`main.py`):**
    * Displays a list of Freshservice clients from `companies_list.json`.
    * Shows Mailchimp linking status (linked email, contact to add, no FS contact).
    * Button to trigger `utils/client_updater.py` to refresh client list and Mailchimp links.
    * "Generate Report" button enabled only for clients with a linked email.
    * Report generation status page.
    * Dispatch page after report generation with options to:
        * Send the HTML report via Mailchimp (as a campaign to the client and a copy internally).
        * View the report directly in the browser.
* **Freshservice Data Pulling & Client Linking (`utils/client_updater.py` & `data_pullers/freshservice.py`):**
    * `client_updater.py` fetches all Freshservice clients (companies or departments) and their details (including prime user/head name).
    * It then fetches all contacts from a specified Mailchimp audience.
    * Attempts to match Freshservice client contacts to Mailchimp contacts by name, with a fallback to matching by company email domain.
    * Stores the updated client list with linking information in `companies_list.json`.
    * `freshservice.py` pulls comprehensive ticket data and related details for a specific client for the previous full month.
* **HTML Report Builder (`build_report.py`):**
    * Loads data for the selected client.
    * Calculates statistics: total tickets, resolved/open, average resolution/first response times (calendar-based), SLA adherence (calendar-based against defined targets for reply and resolution), tickets by type, priority, and category.
    * Generates email-friendly HTML table-based bar charts for visualizing distributions.
    * Outputs a styled HTML report (`output_report.html`).

## Setup

1.  **Clone the Repository.**
2.  **Python Environment:**
    * Python 3.x recommended.
    * Use a virtual environment.
3.  **Install Dependencies:**
    ```bash
    pip install requests python-dateutil Jinja2 Flask 
    # matplotlib is no longer needed if only using HTML charts
    ```
4.  **Configuration:**
    * Create `token.txt` in the project root (`integoreport/`) with your Freshservice API key.
    * Create `mail_token.txt` in the project root with your Mailchimp API key.
    * In `utils/client_updater.py` and `main.py`, update `MAILCHIMP_LIST_ID` with your Mailchimp Audience ID.
    * In `main.py`, configure `COPY_REPORT_TO_EMAIL` with the email address to receive copies of reports.
    * Review `FROM_NAME` and `REPLY_TO` email settings in `main.py` within the `send_report_via_mailchimp` function.

## Running the Application

1.  **Update Client List (as needed, can also be done from web UI):**
    ```bash
    python utils/client_updater.py
    ```
    This will generate/update `companies_list.json`.
2.  **Run the Flask Web Application:**
    ```bash
    python main.py
    ```
    Access the interface at `http://127.0.0.1:5000/`.
    * Use the "Update Client List" button on the web page.
    * For clients with linked emails, click "Generate Report".
    * From the dispatch page, choose to send the email via Mailchimp or view it.

## Next Steps & Future Development

* **Refine Mailchimp Matching:** Improve the robustness of matching Freshservice contacts to Mailchimp contacts (e.g., using fuzzy matching or more sophisticated heuristics if simple name/domain matching isn't sufficient).
* **Error Handling & Logging:** Continue to enhance across all scripts for better diagnostics.
* **Configuration Management:** Move settings (like API keys, list IDs, from/reply-to emails, copy-to email) into a dedicated configuration file or environment variables instead of hardcoding them in scripts.
* **Business Hours for SLAs:** Investigate fetching or allowing configuration of business hours to calculate SLA adherence more accurately (currently uses calendar time).
* **Mailchimp Transactional Email:** For sending individual reports, consider migrating from the Mailchimp Marketing API (campaigns) to Mailchimp Transactional Email (formerly Mandrill) for a more appropriate and potentially more robust email sending mechanism, though this requires a separate API key and setup.
* **Add More Data Pullers:** Microsoft 365, Sentinel One, etc.
* **Historical Reporting/Trends:** Allow report generation for custom date ranges and potentially show trends over time.

## License

This project is licensed under the GPLv3 License.

---
Copyright (c) 2025 David Hamner
